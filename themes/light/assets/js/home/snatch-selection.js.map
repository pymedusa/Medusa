{"version":3,"names":[],"mappings":"","sources":["js/home/snatch-selection.js"],"sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){\nMEDUSA.home.snatchSelection = function () {\n    $(document.body).on('click', '.imdbPlot', event => {\n        $(event.currentTarget).prev('span').toggle();\n        if ($(event.currentTarget).html() === '..show less') {\n            $(event.currentTarget).html('..show more');\n        } else {\n            $(event.currentTarget).html('..show less');\n        }\n        moveSummaryBackground();\n    });\n\n    // Adjust the summary background position and size on page load and resize\n    function moveSummaryBackground() {\n        const height = $('#summary').height() + 10;\n        const top = $('#summary').offset().top + 5;\n        $('#summaryBackground').height(height);\n        $('#summaryBackground').offset({ top, left: 0 });\n        $('#summaryBackground').show();\n    }\n\n    $(window).resize(() => {\n        moveSummaryBackground();\n    });\n\n    const updateSpinner = function (message, showSpinner) {\n        // Get spinner object as needed\n        const spinner = $('#searchNotification');\n        if (showSpinner) {\n            message = '<img id=\"searchingAnim\" src=\"images/loading32' + MEDUSA.config.themeSpinner + '.gif\" height=\"16\" width=\"16\" />&nbsp;' + message;\n        }\n        $(spinner).empty().append(message);\n    };\n\n    // Check the previous status of the history table, for hidden or shown, through the data attribute\n    // data-history-toggle-hidden\n    function toggleHistoryTable() {\n        // eslint-disable-line no-unused-vars\n        // Get previous state which was saved on the wrapper\n        const showOrHide = $('#wrapper').attr('data-history-toggle');\n        $('#historydata').collapse(showOrHide);\n    }\n\n    $.fn.loadContainer = function (path, loadingTxt, errorTxt, callback) {\n        updateSpinner(loadingTxt);\n        $('#manualSearchMeta').load(path + ' #manualSearchMeta meta');\n        $(this).load(path + ' #manualSearchTbody tr', (response, status) => {\n            if (status === 'error') {\n                updateSpinner(errorTxt, false);\n            }\n            if (typeof callback !== 'undefined') {\n                callback();\n            }\n        });\n    };\n\n    // Click event for the download button for snatching a result\n    $(document.body).on('click', '.epManualSearch', event => {\n        event.preventDefault();\n        const link = event.currentTarget;\n        $(link).children('img').prop('src', 'images/loading16.gif');\n        $.getJSON(event.currentTarget.href, data => {\n            if (data.result === 'success') {\n                $(link).children('img').prop('src', 'images/save.png');\n            } else {\n                $(link).children('img').prop('src', 'images/no16.png');\n            }\n        });\n    });\n\n    $.fn.generateStars = function () {\n        return this.each((index, element) => {\n            $(element).html($('<span/>').width($(element).text() * 12));\n        });\n    };\n\n    function initTableSorter(table) {\n        // Nasty hack to re-initialize tablesorter after refresh\n        $(table).tablesorter({\n            widgets: ['saveSort', 'stickyHeaders', 'columnSelector', 'filter'],\n            widgetOptions: {\n                filter_columnFilters: true, // eslint-disable-line camelcase\n                filter_hideFilters: true, // eslint-disable-line camelcase\n                filter_saveFilters: true, // eslint-disable-line camelcase\n                columnSelector_saveColumns: true, // eslint-disable-line camelcase\n                columnSelector_layout: '<label><input type=\"checkbox\">{name}</label>', // eslint-disable-line camelcase\n                columnSelector_mediaquery: false, // eslint-disable-line camelcase\n                columnSelector_cssChecked: 'checked' // eslint-disable-line camelcase\n            },\n            textExtraction: function () {\n                return {\n                    // 2: Provider\n                    2(node) {\n                        return $(node).find('img').attr('title');\n                    },\n                    // 6: The size column needs an explicit field for the filtering on raw size.\n                    6(node) {\n                        return node.getAttribute('data-size');\n                    },\n                    // 9: Published date\n                    9(node) {\n                        return node.getAttribute('data-datetime');\n                    },\n                    // 10: Added date\n                    10(node) {\n                        return node.getAttribute('data-datetime');\n                    }\n                };\n            }(),\n            headers: {\n                9: { sorter: 'realISODate' }, // Published\n                10: { sorter: 'realISODate' }, // Added\n                11: { sorter: false, parser: false // Snatch link\n                } }\n        });\n    }\n\n    $('.imdbstars').generateStars();\n\n    function checkCacheUpdates(repeat) {\n        const self = this;\n        let pollInterval = 5000;\n        repeat = repeat || true;\n\n        const indexerName = $('meta[data-last-prov-updates]').attr('data-indexer-name');\n        const seriesId = $('meta[data-last-prov-updates]').attr('data-series-id');\n        const season = $('meta[data-last-prov-updates]').attr('data-season');\n        const episode = $('meta[data-last-prov-updates]').attr('data-episode');\n        const data = $('meta[data-last-prov-updates]').data('last-prov-updates');\n        const manualSearchType = $('meta[data-last-prov-updates]').attr('data-manual-search-type');\n\n        const checkParams = [indexerName, seriesId, season, episode].every(checkIsTrue => {\n            return checkIsTrue;\n        });\n\n        if (!checkParams) {\n            console.log(```Something went wrong in getthing the paramaters from dom. indexerName: ${indexerName}, \n                        seriesId: ${seriesId}, season: ${season}, episode: ${episode}```);\n            return;\n        }\n\n        let urlParams = '?indexername=' + indexerName + '&seriesid=' + seriesId + '&season=' + season + '&episode=' + episode;\n\n        if (manualSearchType === 'season') {\n            urlParams += '&manual_search_type=' + manualSearchType;\n        }\n\n        if (!$.isNumeric(seriesId) || !$.isNumeric(season) || !$.isNumeric(episode)) {\n            setTimeout(() => {\n                checkCacheUpdates(true);\n            }, 200);\n        }\n\n        self.refreshResults = function () {\n            // @FIXME: In the current transition phase to Vue, we can't load pages in this way, so use reload instead.\n            /*\n            $('#manualSearchTbody').loadContainer(\n                'home/snatchSelection' + urlParams,\n                'Loading new search results...',\n                'Time out, refresh page to try again',\n                toggleHistoryTable // This is a callback function\n            );\n            */\n            window.location.reload();\n        };\n\n        $.ajax({\n            url: 'home/manualSearchCheckCache' + urlParams,\n            type: 'GET',\n            data,\n            contentType: 'application/json',\n            error() {\n                // Repeat = false;\n                console.log('Error occurred!!');\n                $('.manualSearchButton').removeAttr('disabled');\n            },\n            complete() {\n                if (repeat) {\n                    setTimeout(checkCacheUpdates, pollInterval);\n                }\n            },\n            timeout: 15000 // Timeout after 15s\n        }).done(data => {\n            // @TODO: Combine the lower if statements\n            if (data === '') {\n                updateSpinner('Search finished', false);\n                $('.manualSearchButton').removeAttr('disabled');\n                repeat = false;\n            }\n\n            if (data.result === 'refresh') {\n                self.refreshResults();\n                updateSpinner('Refreshed results...', true);\n            }\n            if (data.result === 'searching') {\n                // Ep is searched, you will get a results any minute now\n                pollInterval = 5000;\n                $('.manualSearchButton').prop('disabled', true);\n                updateSpinner('The episode is being searched, please wait......', true);\n            }\n            if (data.result === 'queued') {\n                // Ep is queued, this might take some time to get results\n                pollInterval = 7000;\n                $('.manualSearchButton').prop('disabled', true);\n                updateSpinner('The episode has been queued, because another search is taking place. please wait..', true);\n            }\n            if (data.result === 'finished') {\n                // Ep search is finished\n                updateSpinner('Search finished', false);\n                $('.manualSearchButton').removeAttr('disabled');\n                repeat = false;\n                $('#srchresults').trigger('update', true);\n                $('[datetime]').timeago();\n            }\n            if (data.result === 'error') {\n                // Ep search is finished but with an error\n                console.log('Probably tried to call manualSelectCheckCache, while page was being refreshed.');\n                $('.manualSearchButton').removeAttr('disabled');\n                repeat = true;\n            }\n        });\n    }\n\n    setTimeout(checkCacheUpdates, 2000);\n\n    // Click event for the reload results and force search buttons\n    $(document.body).on('click', '.manualSearchButton', event => {\n        event.preventDefault();\n        $('.manualSearchButton').prop('disabled', true);\n        const indexerName = $('meta[data-last-prov-updates]').attr('data-indexer-name');\n        const seriesId = $('meta[data-last-prov-updates]').attr('data-series-id');\n        const season = $('meta[data-last-prov-updates]').attr('data-season');\n        const episode = $('meta[data-last-prov-updates]').attr('data-episode');\n        const manualSearchType = $('meta[data-last-prov-updates]').attr('data-manual-search-type');\n        const forceSearch = $(event.currentTarget).attr('data-force-search');\n\n        const checkParams = [indexerName, seriesId, season, episode].every(checkIsTrue => {\n            return checkIsTrue;\n        });\n\n        if (!checkParams) {\n            console.log(```Something went wrong in getthing the paramaters from dom. indexerName: ${indexerName},\n                        seriesId: ${seriesId}, season: ${season}, episode: ${episode}```);\n            return;\n        }\n\n        if ($.isNumeric(seriesId) && $.isNumeric(season) && $.isNumeric(episode)) {\n            updateSpinner('Started a forced manual search...', true);\n            $.getJSON('home/snatchSelection', {\n                indexername: indexerName,\n                seriesid: seriesId,\n                season,\n                episode,\n                manual_search_type: manualSearchType, // eslint-disable-line camelcase\n                perform_search: forceSearch // eslint-disable-line camelcase\n            });\n            // Force the search, but give the checkCacheUpdates the time to start up a search thread\n            setTimeout(() => {\n                checkCacheUpdates(true);\n            }, 2000);\n        }\n    });\n\n    // Moved and rewritten this from displayShow. This changes the button when clicked for collapsing/expanding the\n    // \"Show History\" button to show or hide the snatch/download/failed history for a manual searched episode or pack.\n\n    $('#popover').popover({\n        placement: 'bottom',\n        html: true, // Required if content has HTML\n        content: '<div id=\"popover-target\"></div>'\n    }).on('shown.bs.popover', () => {\n        // Bootstrap popover event triggered when the popover opens\n        $.tablesorter.columnSelector.attachTo($('#srchresults'), '#popover-target');\n    });\n\n    $('#btnReset').click(() => {\n        $('#showTable').trigger('saveSortReset') // Clear saved sort\n        .trigger('sortReset'); // Reset current table sort\n        return false;\n    });\n\n    $(() => {\n        initTableSorter('#srchresults');\n        moveSummaryBackground();\n        $('body').on('hide.bs.collapse', '.collapse.toggle', () => {\n            $('#showhistory').text('Show History');\n            $('#wrapper').prop('data-history-toggle', 'hide');\n        });\n        $('body').on('show.bs.collapse', '.collapse.toggle', () => {\n            $('#showhistory').text('Hide History');\n            $('#wrapper').prop('data-history-toggle', 'show');\n        });\n    });\n\n    $(document.body).on('click', '.release-name-ellipses, .release-name-ellipses-toggled', event => {\n        const target = $(event.currentTarget);\n\n        if (target.hasClass('release-name-ellipses')) {\n            target.switchClass('release-name-ellipses', 'release-name-ellipses-toggled', 100);\n        } else {\n            target.switchClass('release-name-ellipses-toggled', 'release-name-ellipses', 100);\n        }\n    });\n};\n\n},{}]},{},[1]);\n"],"file":"snatch-selection.js"}